<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì›¹ ë©”ì‹ ì €</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Fredoka:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #7C3AED;
            --primary-dark: #6D28D9;
            --primary-light: #A78BFA;
            --secondary: #EC4899;
            --bg-main: #0F0F1E;
            --bg-card: #1A1A2E;
            --bg-hover: #252541;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --border: #2D2D44;
            --success: #10B981;
            --error: #EF4444;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Noto Sans KR',sans-serif;background:var(--bg-main);color:var(--text-primary);height:100vh;overflow:hidden}
        .btn{padding:10px 16px;border:none;border-radius:10px;font-weight:600;cursor:pointer;font-family:inherit}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
        .btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border)}
        .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .error-message{display:none;background:rgba(239,68,68,0.08);border:1px solid var(--error);color:var(--error);padding:10px;border-radius:8px;margin-bottom:10px}
        .error-message.show{display:block}
        .success-message{display:none;background:rgba(16,185,129,0.08);border:1px solid var(--success);color:var(--success);padding:10px;border-radius:8px;margin-bottom:10px}
        .success-message.show{display:block}

        /* auth */
        .auth-container{display:flex;align-items:center;justify-content:center;height:100vh;padding:20px}
        .auth-box{background:var(--bg-card);border:1px solid var(--border);border-radius:18px;padding:36px;width:100%;max-width:480px;box-shadow:0 10px 45px rgba(0,0,0,0.5)}
        .auth-logo h1{font-family:'Fredoka',sans-serif;font-size:40px;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
        .form-group{margin-bottom:14px}
        .form-group label{display:block;margin-bottom:6px;color:var(--text-secondary);font-size:13px}
        .form-group input, textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--bg-main);color:var(--text-primary);font-size:14px}

        /* main layout */
        .main-app{display:flex;height:100vh}
        .sidebar-nav{width:80px;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:16px 8px}
        .nav-logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:8px}
        .nav-items{flex:1;display:flex;flex-direction:column;gap:12px}
        .nav-item{width:56px;height:56px;border-radius:12px;background:transparent;border:none;color:var(--text-secondary);cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center}
        .nav-item.active{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 4px 12px rgba(124,58,237,0.35)}
        .nav-user{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--primary-light),var(--secondary));display:flex;align-items:center;justify-content:center;font-weight:700;margin-top:8px;cursor:pointer}
        .logout-btn{margin-top:8px;width:48px;height:48px;border-radius:12px;background:transparent;border:none;color:var(--text-secondary);cursor:pointer}

        /* panels */
        .friends-panel{width:360px;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column}
        .panel-header{padding:18px;border-bottom:1px solid var(--border)}
        .panel-header h2{font-size:20px;margin-bottom:8px}
        .search-box{position:relative}
        .search-box input{padding-left:40px}
        .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-secondary)}

        .panel-tabs{display:flex;gap:8px;padding:10px}
        .tab-btn{padding:8px 10px;border-radius:8px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;font-weight:600}
        .tab-btn.active{background:var(--primary);color:#fff}

        .panel-content{flex:1;padding:12px;overflow:auto}
        .friend-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;cursor:pointer}
        .friend-avatar{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary),var(--secondary));font-weight:700}
        .friend-avatar.online::after{content:'';position:absolute;width:12px;height:12px;border-radius:50%;background:var(--success);border:2px solid var(--bg-card);margin-left:28px;margin-top:28px}

        /* messages panel */
        .messages-panel{width:320px;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column}
        .chat-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;cursor:pointer}
        .chat-avatar{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary),var(--secondary));font-weight:700}

        /* chat area */
        .chat-area{flex:1;display:flex;flex-direction:column;background:var(--bg-main)}
        .chat-header{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border);background:var(--bg-card)}
        .chat-header-left{display:flex;align-items:center;gap:12px}
        .messages-container{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px}
        .message{display:flex;gap:12px;max-width:75%;animation:fade .2s}
        @keyframes fade{from{opacity:.4;transform:translateY(6px)}to{opacity:1;transform:none}}
        .message.sent{margin-left:auto;flex-direction:row-reverse}
        .message-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary-light),var(--secondary));font-weight:600}
        .message-bubble{padding:10px 12px;border-radius:12px;background:var(--bg-card);color:var(--text-primary);word-break:break-word;max-width:100%}
        .message.sent .message-bubble{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border-radius:12px 12px 4px 12px}
        .message img.message-image{max-width:320px;border-radius:10px;display:block}

        .message-meta{font-size:11px;color:var(--text-secondary);margin-top:6px}
        .read-indicator{font-size:11px;color:var(--text-secondary);margin-top:6px;text-align:right}

        .input-area{padding:12px;border-top:1px solid var(--border);background:var(--bg-card)}
        .input-wrapper{display:flex;gap:8px;align-items:flex-end}
        .message-input{flex:1;border-radius:999px;padding:10px 14px;border:1px solid var(--border);background:var(--bg-main);color:var(--text-primary);resize:none;max-height:120px}
        .attachment-btn{width:40px;height:40px;border-radius:50%;background:var(--bg-main);border:none;color:var(--text-secondary);cursor:pointer;font-size:18px}
        .send-btn{width:44px;height:44px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;cursor:pointer}

        /* emoji panel */
        .emoji-panel{position:absolute;bottom:72px;right:120px;background:var(--bg-card);border:1px solid var(--border);padding:8px;border-radius:10px;display:grid;grid-template-columns:repeat(8,28px);gap:6px;box-shadow:0 8px 30px rgba(0,0,0,0.4);z-index:50}
        .emoji-item{font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}

        /* modal for upload progress */
        .upload-overlay{position:fixed;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:100;display:none}
        .upload-overlay.active{display:flex}
        .upload-box{background:var(--bg-card);padding:16px;border-radius:10px;border:1px solid var(--border)}

        /* small helpers */
        .small{font-size:12px;color:var(--text-secondary)}
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… (ê°„ë‹¨) -->
    <div class="auth-container" id="loginWrap">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>ğŸ’¬ ChatApp</h1>
                <p class="small">ì¹œêµ¬ë“¤ê³¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì†Œí†µí•˜ì„¸ìš”</p>
            </div>

            <div class="error-message" id="loginError"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="loginIdentifier">ì•„ì´ë”” ë˜ëŠ” ì´ë©”ì¼</label>
                    <input id="loginIdentifier" type="text" required placeholder="ì•„ì´ë”” ë˜ëŠ” ì´ë©”ì¼" />
                </div>
                <div class="form-group">
                    <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <input id="loginPassword" type="password" required placeholder="ë¹„ë°€ë²ˆí˜¸" />
                </div>
                <div class="form-actions">
                    <button id="loginBtn" class="btn btn-primary" type="submit">ë¡œê·¸ì¸</button>
                </div>
            </form>

            <div style="margin-top:10px;text-align:center" class="small">
                ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a id="showSignup" style="color:var(--primary);cursor:pointer">íšŒì›ê°€ì…</a>
            </div>
        </div>
    </div>

    <div class="auth-container" id="signupWrap" style="display:none">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>ğŸ’¬ ChatApp</h1>
                <p class="small">ìƒˆ ê³„ì •ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
            </div>

            <div class="error-message" id="signupError"></div>
            <div class="success-message" id="signupSuccess"></div>

            <form id="signupForm">
                <div class="form-group">
                    <label for="signupUsername">ì•„ì´ë””</label>
                    <input id="signupUsername" type="text" required placeholder="ì˜ë¬¸ìˆ«ì 4-20ì" />
                </div>
                <div class="form-group">
                    <label for="signupEmail">ì´ë©”ì¼</label>
                    <input id="signupEmail" type="email" required placeholder="email@example.com" />
                </div>
                <div class="form-group">
                    <label for="signupName">ì´ë¦„</label>
                    <input id="signupName" type="text" required placeholder="í™ê¸¸ë™" />
                </div>
                <div class="form-group">
                    <label for="signupPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <input id="signupPassword" type="password" required placeholder="6ì ì´ìƒ" />
                </div>
                <div class="form-group">
                    <label for="signupPasswordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input id="signupPasswordConfirm" type="password" required placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" />
                </div>
                <div class="form-actions">
                    <button id="signupBtn" class="btn btn-primary" type="submit">íšŒì›ê°€ì…</button>
                    <button id="backToLogin" type="button" class="btn btn-secondary">ëŒì•„ê°€ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± -->
    <div class="main-app" id="mainApp" style="display:none">
        <nav class="sidebar-nav">
            <div class="nav-logo">ğŸ’¬</div>
            <div class="nav-items">
                <button class="nav-item active" data-view="friends" title="ì¹œêµ¬">ğŸ‘¥</button>
                <button class="nav-item" data-view="messages" title="ë©”ì‹œì§€">ğŸ’¬ <span id="unreadBadge" style="display:none;position:absolute;right:6px;top:6px;background:var(--error);color:#fff;border-radius:50%;padding:2px 6px;font-size:11px"></span></button>
            </div>

            <div class="nav-user" id="userProfile" title="ì„¤ì • ì—´ê¸°">U</div>
            <button class="logout-btn" id="logoutBtn" title="ë¡œê·¸ì•„ì›ƒ">ğŸšª</button>
        </nav>

        <aside class="friends-panel" id="friendsPanel">
            <div class="panel-header">
                <h2>ì¹œêµ¬</h2>
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input id="friendSearch" placeholder="ì¹œêµ¬ ê²€ìƒ‰..." />
                </div>
            </div>

            <div class="panel-tabs" id="friendsTabs">
                <button class="tab-btn active" data-tab="friends-list">ì¹œêµ¬ ëª©ë¡</button>
                <button class="tab-btn" data-tab="requests">ìš”ì²­ <span id="requestCount" class="small"></span></button>
                <button class="tab-btn" data-tab="add-friend">ì¹œêµ¬ ì¶”ê°€</button>
            </div>

            <div class="panel-content">
                <div id="friendsList">
                    <div class="empty-state" style="text-align:center;padding:20px;color:var(--text-secondary)">
                        <div style="font-size:36px;margin-bottom:8px">ğŸ‘¥</div>
                        <div>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="small">ì¹œêµ¬ ìš”ì²­ì„ ë³´ë‚´ë³´ì„¸ìš”</div>
                    </div>
                </div>

                <div id="friendRequests" style="display:none">
                    <div id="requestsList">
                        <div class="empty-state" style="text-align:center;padding:20px;color:var(--text-secondary)">
                            <div style="font-size:36px;margin-bottom:8px">ğŸ“¨</div>
                            <div>ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    </div>
                </div>

                <div id="addFriend" style="display:none">
                    <div style="padding:12px">
                        <div class="error-message" id="addFriendError"></div>
                        <div class="success-message" id="addFriendSuccess"></div>
                        <div class="form-group">
                            <label>ì¹œêµ¬ ì•„ì´ë””</label>
                            <input id="friendUsername" placeholder="friend123" />
                        </div>
                        <div style="display:flex;gap:8px">
                            <button id="addFriendBtn" class="btn btn-primary">ìš”ì²­ ë³´ë‚´ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <aside class="messages-panel" id="messagesPanel" style="display:flex">
            <div class="panel-header">
                <h2>ë©”ì‹œì§€</h2>
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input placeholder="ëŒ€í™” ê²€ìƒ‰..." />
                </div>
            </div>

            <div class="panel-content" id="chatList">
                <div class="empty-state" style="text-align:center;padding:20px;color:var(--text-secondary)">
                    <div style="font-size:36px;margin-bottom:8px">ğŸ’¬</div>
                    <div>ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>
        </aside>

        <main class="chat-area" id="chatArea">
            <div class="empty-state" style="text-align:center;padding:20px;color:var(--text-secondary)">
                <div style="font-size:36px;margin-bottom:8px">ğŸ’¬</div>
                <div>ëŒ€í™”ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
            </div>
        </main>
    </div>

    <!-- hidden file input for uploads -->
    <input type="file" id="fileInput" accept="image/*" style="display:none" />

    <!-- emoji panel placeholder (created dynamically) -->

    <!-- upload overlay -->
    <div class="upload-overlay" id="uploadOverlay">
        <div class="upload-box">
            <div id="uploadStatus">ì—…ë¡œë“œ ì¤‘...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getDatabase, ref as dbRef, set, push, onValue, get, update, off
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import {
            getStorage, ref as storageRef, uploadBytes, getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Firebase ì„¤ì • (ê¸°ì¡´ ê°’ ìœ ì§€)
        const firebaseConfig = {
            apiKey: "AIzaSyDyAtNIrWfsROkqi8op6zynWZfjBwEMeh8",
            authDomain: "mess-db5a2.firebaseapp.com",
            databaseURL: "https://mess-db5a2-default-rtdb.firebaseio.com",
            projectId: "mess-db5a2",
            storageBucket: "mess-db5a2.appspot.com",
            messagingSenderId: "125385749508",
            appId: "1:125385749508:web:f3e80ebb8cfd9e397af151",
            measurementId: "G-W6LN7XGMZB"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        let currentUser = null;
        let currentChatId = null;
        let currentChatUser = null;

        // ë¦¬ìŠ¤ë„ˆ refs
        let friendsRef = null;
        let chatsRef = null;
        let messagesRef = null;
        let requestsRef = null;

        // ì´ë©”ì¼ í‚¤ sanitize (Firebase path ê¸ˆì§€ ë¬¸ì ì²˜ë¦¬)
        function sanitizeKey(str) {
            if (!str || typeof str !== 'string') return str;
            return str.replace(/[.#$\[\]]/g, (c) => '%' + c.charCodeAt(0).toString(16));
        }

        // -------------------- UI helpers --------------------
        const loginWrap = document.getElementById('loginWrap');
        const signupWrap = document.getElementById('signupWrap');
        const mainApp = document.getElementById('mainApp');

        function showLogin() {
            loginWrap.style.display = '';
            signupWrap.style.display = 'none';
            mainApp.style.display = 'none';
        }
        function showSignup() {
            loginWrap.style.display = 'none';
            signupWrap.style.display = '';
            mainApp.style.display = 'none';
        }
        function showMainApp() {
            loginWrap.style.display = 'none';
            signupWrap.style.display = 'none';
            mainApp.style.display = '';
        }

        // -------------------- Authentication (simple DB based) --------------------
        document.getElementById('showSignup').addEventListener('click', showSignup);
        document.getElementById('backToLogin').addEventListener('click', showLogin);

        // Signup
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signupUsername').value.trim().toLowerCase();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const name = document.getElementById('signupName').value.trim();
            const pwd = document.getElementById('signupPassword').value;
            const pwdConfirm = document.getElementById('signupPasswordConfirm').value;
            const err = document.getElementById('signupError');
            const ok = document.getElementById('signupSuccess');
            err.classList.remove('show'); ok.classList.remove('show');

            if (!/^[a-zA-Z0-9]{4,20}$/.test(username)) { err.textContent = 'ì•„ì´ë””ëŠ” ì˜ë¬¸/ìˆ«ì 4-20ìì…ë‹ˆë‹¤.'; err.classList.add('show'); return; }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { err.textContent = 'ìœ íš¨í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'; err.classList.add('show'); return; }
            if (pwd.length < 6) { err.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; err.classList.add('show'); return; }
            if (pwd !== pwdConfirm) { err.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; err.classList.add('show'); return; }

            const btn = document.getElementById('signupBtn'); btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> ê°€ì… ì¤‘...';
            try {
                const usernameSnap = await get(dbRef(database, `usernames/${username}`));
                if (usernameSnap.exists()) { err.textContent = 'ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'; err.classList.add('show'); return; }
                const emailKey = sanitizeKey(email);
                const emailSnap = await get(dbRef(database, `emails/${emailKey}`));
                if (emailSnap.exists()) { err.textContent = 'ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.'; err.classList.add('show'); return; }

                const userId = push(dbRef(database, 'users')).key;
                const hashed = btoa(pwd);
                await set(dbRef(database, `users/${userId}`), {
                    username, email, name, password: hashed, status: 'ì•ˆë…•í•˜ì„¸ìš”!', createdAt: Date.now(), online: false
                });
                await set(dbRef(database, `usernames/${username}`), userId);
                await set(dbRef(database, `emails/${emailKey}`), userId);

                ok.textContent = 'íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•˜ì„¸ìš”.'; ok.classList.add('show');
                document.getElementById('signupForm').reset();
                setTimeout(showLogin, 1200);
            } catch (err2) {
                console.error(err2);
                err.textContent = 'íšŒì›ê°€ì… ì˜¤ë¥˜: ' + (err2.message || err2); err.classList.add('show');
            } finally {
                btn.disabled = false; btn.textContent = 'íšŒì›ê°€ì…';
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = document.getElementById('loginIdentifier').value.trim().toLowerCase();
            const pwd = document.getElementById('loginPassword').value;
            const err = document.getElementById('loginError');
            err.classList.remove('show');
            const btn = document.getElementById('loginBtn'); btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> ë¡œê·¸ì¸ ì¤‘...';
            try {
                let userId = null;
                const usernameSnap = await get(dbRef(database, `usernames/${identifier}`));
                if (usernameSnap.exists()) userId = usernameSnap.val();
                else {
                    const emailKey = sanitizeKey(identifier);
                    const emailSnap = await get(dbRef(database, `emails/${emailKey}`));
                    if (emailSnap.exists()) userId = emailSnap.val();
                }
                if (!userId) { err.textContent = 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤.'; err.classList.add('show'); return; }

                const userSnap = await get(dbRef(database, `users/${userId}`));
                if (!userSnap.exists()) { err.textContent = 'ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; err.classList.add('show'); return; }
                const data = userSnap.val();
                if (data.password !== btoa(pwd)) { err.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; err.classList.add('show'); return; }

                currentUser = { uid: userId, username: data.username, name: data.name, email: data.email || '', status: data.status || '' };
                localStorage.setItem('chatAppUser', JSON.stringify(currentUser));
                await update(dbRef(database, `users/${currentUser.uid}`), { online: true, lastSeen: Date.now() });

                showMainApp();
                loadUserData();
                loadFriends();
                loadChats();
                loadFriendRequests();
            } catch (err2) {
                console.error(err2);
                err.textContent = 'ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + (err2.message || err2); err.classList.add('show');
            } finally {
                btn.disabled = false; btn.textContent = 'ë¡œê·¸ì¸';
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                if (currentUser) await update(dbRef(database, `users/${currentUser.uid}`), { online: false, lastSeen: Date.now() });
            } catch(e) { console.warn(e) }
            cleanupAllListeners();
            localStorage.removeItem('chatAppUser');
            currentUser = null;
            showLogin();
        });

        // On load, check localStorage
        (function initFromStorage(){
            const saved = localStorage.getItem('chatAppUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                showMainApp();
                loadUserData();
                loadFriends();
                loadChats();
                loadFriendRequests();
                update(dbRef(database, `users/${currentUser.uid}`), { online: true, lastSeen: Date.now() }).catch(()=>{});
            } else {
                showLogin();
            }
        })();

        // -------------------- user UI --------------------
        function loadUserData() {
            if (!currentUser) return;
            const el = document.getElementById('userProfile');
            el.textContent = currentUser.username ? currentUser.username.charAt(0).toUpperCase() : (currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U');
        }

        // -------------------- friends & friend requests --------------------
        async function loadFriends() {
            if (!currentUser) return;
            try {
                if (friendsRef) { try { off(friendsRef); } catch(e){} }
                friendsRef = dbRef(database, `friends/${currentUser.uid}`);
                onValue(friendsRef, async (snap) => {
                    const container = document.getElementById('friendsList'); container.innerHTML = '';
                    if (!snap.exists()) {
                        container.innerHTML = `<div class="empty-state" style="text-align:center;padding:20px;color:var(--text-secondary)"><div style="font-size:36px;margin-bottom:8px">ğŸ‘¥</div><div>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>`;
                        return;
                    }
                    const ids = Object.keys(snap.val());
                    for (const fid of ids) {
                        const uSnap = await get(dbRef(database, `users/${fid}`));
                        if (!uSnap.exists()) continue;
                        const u = uSnap.val();
                        const item = document.createElement('div'); item.className = 'friend-item';
                        item.innerHTML = `<div class="friend-avatar ${u.online ? 'online' : ''}">${u.username ? u.username.charAt(0).toUpperCase() : '?'}</div>
                            <div style="flex:1;min-width:0">
                                <div style="font-weight:700">${u.name || 'ì´ë¦„ ì—†ìŒ'}</div>
                                <div class="small">@${u.username || ''} â€¢ <span class="small">${u.status || ''}</span></div>
                            </div>`;
                        item.addEventListener('click', ()=> openChat(fid, u));
                        container.appendChild(item);
                    }
                });
            } catch (e) { console.error(e) }
        }

        // Friend requests load
        function loadFriendRequests() {
            if (!currentUser) return;
            try {
                if (requestsRef) { try { off(requestsRef); } catch(e){} }
                requestsRef = dbRef(database, `friendRequests/${currentUser.uid}`);
                onValue(requestsRef, async (snap) => {
                    const list = document.getElementById('requestsList'); list.innerHTML = '';
                    const countEl = document.getElementById('requestCount');
                    if (!snap.exists()) {
                        list.innerHTML = `<div class="empty-state" style="text-align:center;padding:20px;color:var(--text-secondary)"><div style="font-size:36px;margin-bottom:8px">ğŸ“¨</div><div>ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>`;
                        countEl.textContent = '';
                        return;
                    }
                    const reqs = snap.val(); const entries = Object.entries(reqs);
                    countEl.textContent = `(${entries.length})`;
                    for (const [senderId, data] of entries) {
                        const uSnap = await get(dbRef(database, `users/${senderId}`));
                        const u = uSnap.exists() ? uSnap.val() : { username: data.username || 'unknown', name: data.name || 'ì´ë¦„ ì—†ìŒ' };
                        const item = document.createElement('div'); item.className = 'friend-item';
                        item.innerHTML = `<div class="friend-avatar">${u.username ? u.username.charAt(0).toUpperCase() : '?'}</div>
                            <div style="flex:1;min-width:0">
                                <div style="font-weight:700">${u.name || 'ì´ë¦„ ì—†ìŒ'}</div>
                                <div class="small">@${u.username || ''} â€¢ ìš”ì²­: ${new Date(data.timestamp || Date.now()).toLocaleString()}</div>
                            </div>
                            <div style="display:flex;gap:6px">
                                <button class="btn btn-secondary btn-reject" data-id="${senderId}">ê±°ì ˆ</button>
                                <button class="btn btn-primary btn-accept" data-id="${senderId}">ìˆ˜ë½</button>
                            </div>`;
                        item.querySelector('.btn-accept').addEventListener('click', ()=> acceptFriendRequest(senderId));
                        item.querySelector('.btn-reject').addEventListener('click', ()=> rejectFriendRequest(senderId));
                        list.appendChild(item);
                    }
                });
            } catch (e) { console.error(e) }
        }

        async function acceptFriendRequest(senderId) {
            if (!currentUser) return;
            try {
                await set(dbRef(database, `friends/${currentUser.uid}/${senderId}`), { addedAt: Date.now() });
                await set(dbRef(database, `friends/${senderId}/${currentUser.uid}`), { addedAt: Date.now() });
                await set(dbRef(database, `friendRequests/${currentUser.uid}/${senderId}`), null);
                alert('ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.');
                loadFriends();
            } catch(e){ console.error(e); alert('ìˆ˜ë½ ì˜¤ë¥˜') }
        }
        async function rejectFriendRequest(senderId) {
            if (!currentUser) return;
            try {
                await set(dbRef(database, `friendRequests/${currentUser.uid}/${senderId}`), null);
                alert('ì¹œêµ¬ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
            } catch(e){ console.error(e); alert('ê±°ì ˆ ì˜¤ë¥˜') }
        }

        // Send friend request (changed behavior: create friendRequests entry)
        document.getElementById('addFriendBtn').addEventListener('click', async () => {
            const username = document.getElementById('friendUsername').value.trim().toLowerCase();
            const err = document.getElementById('addFriendError'); const ok = document.getElementById('addFriendSuccess'); err.classList.remove('show'); ok.classList.remove('show');
            if (!username) { err.textContent = 'ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”'; err.classList.add('show'); return; }
            if (username === currentUser.username) { err.textContent = 'ìê¸° ìì‹ ì€ ë¶ˆê°€'; err.classList.add('show'); return; }
            const btn = document.getElementById('addFriendBtn'); btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> ìš”ì²­ ì¤‘...';
            try {
                const uSnap = await get(dbRef(database, `usernames/${username}`));
                if (!uSnap.exists()) { err.textContent = 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'; err.classList.add('show'); return; }
                const recipientId = uSnap.val();

                // already friends?
                const fSnap = await get(dbRef(database, `friends/${currentUser.uid}/${recipientId}`));
                if (fSnap.exists()) { err.textContent = 'ì´ë¯¸ ì¹œêµ¬ì…ë‹ˆë‹¤'; err.classList.add('show'); return; }

                // already requested?
                const rSnap = await get(dbRef(database, `friendRequests/${recipientId}/${currentUser.uid}`));
                if (rSnap.exists()) { err.textContent = 'ì´ë¯¸ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤'; err.classList.add('show'); return; }

                await set(dbRef(database, `friendRequests/${recipientId}/${currentUser.uid}`), {
                    from: currentUser.uid, username: currentUser.username, name: currentUser.name || '', timestamp: Date.now(), status: 'pending'
                });

                ok.textContent = 'ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤'; ok.classList.add('show'); document.getElementById('friendUsername').value = '';
            } catch(e) { console.error(e); err.textContent = 'ìš”ì²­ ì¤‘ ì˜¤ë¥˜: ' + (e.message||e); err.classList.add('show'); }
            finally { btn.disabled = false; btn.textContent = 'ìš”ì²­ ë³´ë‚´ê¸°'; }
        });

        // -------------------- chats & messages --------------------
        function openChat(friendId, friendData) {
            currentChatUser = { id: friendId, data: friendData };
            currentChatId = [currentUser.uid, friendId].sort().join('_');

            // remove previous messages listener
            if (messagesRef) { try { off(messagesRef); } catch(e){} messagesRef = null; }

            // switch nav active
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            document.querySelector('[data-view="messages"]').classList.add('active');

            // panels
            document.getElementById('friendsPanel').style.display = 'none';
            document.getElementById('messagesPanel').style.display = 'flex';
            document.getElementById('chatArea').style.display = 'flex';

            // render header & input
            const initial = friendData.username ? friendData.username.charAt(0).toUpperCase() : '?';
            const onlineStatus = friendData.online ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = `
                <div class="chat-header">
                    <div class="chat-header-left">
                        <div class="friend-avatar" style="width:42px;height:42px;border-radius:50%">${initial}</div>
                        <div>
                            <div style="font-weight:700">${friendData.name || 'ì´ë¦„ ì—†ìŒ'}</div>
                            <div class="small">${onlineStatus} â€¢ ${friendData.status || ''}</div>
                        </div>
                    </div>
                    <div>
                        <button class="attachment-btn" id="fileBtn" title="ì‚¬ì§„ ì²¨ë¶€">ğŸ“</button>
                        <button class="attachment-btn" id="emojiBtn" title="ì´ëª¨í‹°ì½˜">ğŸ˜Š</button>
                    </div>
                </div>
                <div class="messages-container" id="messagesContainer"></div>
                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea id="messageInput" class="message-input" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <button id="sendBtn" class="send-btn">â¤</button>
                    </div>
                </div>
            `;

            // setup input events
            setupMessageInput();

            // load messages
            loadMessages();

            // mark chat-level unread false (we clicked chat)
            update(dbRef(database, `chats/${currentUser.uid}/${friendId}`), { unread: false }).catch(()=>{});
        }

        function setupMessageInput() {
            const textarea = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const fileBtn = document.getElementById('fileBtn');
            const emojiBtn = document.getElementById('emojiBtn');

            if (!textarea || !sendBtn) return;

            textarea.addEventListener('input', function(){
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            textarea.addEventListener('keypress', function(e){
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });
            sendBtn.addEventListener('click', sendMessage);

            // file upload
            if (fileBtn) {
                fileBtn.addEventListener('click', () => {
                    const fileInput = document.getElementById('fileInput');
                    fileInput.value = '';
                    fileInput.click();
                });
            }

            // emoji panel
            if (emojiBtn) {
                emojiBtn.addEventListener('click', toggleEmojiPanel);
            }
        }

        // emoji panel logic
        let emojiPanel = null;
        const EMOJIS = ['ğŸ˜€','ğŸ˜','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜','ğŸ˜˜','ğŸ¤—','ğŸ¤”','ğŸ˜','ğŸ˜­','ğŸ˜…','ğŸ˜‡','ğŸ¤©','ğŸ˜´','ğŸ‘','ğŸ‘','ğŸ‘','ğŸ™','ğŸ‰','â¤ï¸','ğŸ”¥','ğŸ’¯','ğŸ¤','ğŸ¤','ğŸ™Œ','ğŸ˜¬','ğŸ˜¡','ğŸ¤–','ğŸŒ¸','ğŸ•','â˜•'];

        function toggleEmojiPanel() {
            if (!emojiPanel) createEmojiPanel();
            const panel = emojiPanel;
            if (panel.style.display === 'block') { panel.style.display = 'none'; return; }
            panel.style.display = 'block';
        }

        function createEmojiPanel() {
            emojiPanel = document.createElement('div');
            emojiPanel.className = 'emoji-panel';
            EMOJIS.forEach(e => {
                const btn = document.createElement('div'); btn.className = 'emoji-item'; btn.textContent = e;
                btn.addEventListener('click', () => {
                    insertEmoji(e);
                    emojiPanel.style.display = 'none';
                });
                emojiPanel.appendChild(btn);
            });
            document.body.appendChild(emojiPanel);
            // hide on outside click
            document.addEventListener('click', (ev) => {
                if (!emojiPanel) return;
                if (ev.target.closest('.emoji-panel') || ev.target.id === 'emojiBtn') return;
                emojiPanel.style.display = 'none';
            });
        }

        function insertEmoji(emoji) {
            const ta = document.getElementById('messageInput');
            if (!ta) return;
            const start = ta.selectionStart || ta.value.length;
            const end = ta.selectionEnd || start;
            ta.value = ta.value.slice(0,start) + emoji + ta.value.slice(end);
            ta.focus();
            ta.selectionStart = ta.selectionEnd = start + emoji.length;
            ta.dispatchEvent(new Event('input'));
        }

        // send message (text)
        async function sendMessage() {
            const ta = document.getElementById('messageInput');
            if (!ta || !currentChatId || !currentChatUser) return;
            const text = ta.value.trim();
            if (!text) return;
            try {
                const mRef = dbRef(database, `messages/${currentChatId}`);
                const pushed = await push(mRef, {
                    type: 'text',
                    text: text,
                    senderId: currentUser.uid,
                    senderUsername: currentUser.username,
                    timestamp: Date.now()
                });

                // update chat summaries for both users
                await update(dbRef(database, `chats/${currentUser.uid}/${currentChatUser.id}`), {
                    lastMessage: text, lastMessageTime: Date.now(), unread: false
                });
                await update(dbRef(database, `chats/${currentChatUser.id}/${currentUser.uid}`), {
                    lastMessage: text, lastMessageTime: Date.now(), unread: true
                });

                ta.value = ''; ta.style.height = 'auto';
            } catch (e) {
                console.error('sendMessage error', e);
                alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + (e.message||e));
            }
        }

        // handle file upload selection
        document.getElementById('fileInput').addEventListener('change', async (ev) => {
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            if (!currentChatId || !currentChatUser) { alert('ëŒ€í™”ë¥¼ ë¨¼ì € ì—´ì–´ì£¼ì„¸ìš”.'); return; }

            // show overlay
            const overlay = document.getElementById('uploadOverlay');
            const status = document.getElementById('uploadStatus');
            overlay.classList.add('active');
            status.textContent = 'ì—…ë¡œë“œ ì¤‘...';

            try {
                // path: uploads/{senderUid}/{timestamp}_{encodeURIComponent(name)}
                const safeName = encodeURIComponent(file.name.replace(/\s+/g,'_'));
                const path = `uploads/${currentUser.uid}/${Date.now()}_${safeName}`;
                const sRef = storageRef(storage, path);
                await uploadBytes(sRef, file);
                const url = await getDownloadURL(sRef);

                // push message with type image
                await push(dbRef(database, `messages/${currentChatId}`), {
                    type: 'image',
                    imageUrl: url,
                    filename: file.name,
                    senderId: currentUser.uid,
                    senderUsername: currentUser.username,
                    timestamp: Date.now()
                });

                // update chat summaries
                await update(dbRef(database, `chats/${currentUser.uid}/${currentChatUser.id}`), {
                    lastMessage: '[ì´ë¯¸ì§€]', lastMessageTime: Date.now(), unread: false
                });
                await update(dbRef(database, `chats/${currentChatUser.id}/${currentUser.uid}`), {
                    lastMessage: '[ì´ë¯¸ì§€]', lastMessageTime: Date.now(), unread: true
                });

            } catch(e) {
                console.error('upload error', e);
                alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (e.message||e));
            } finally {
                overlay.classList.remove('active');
            }
        });

        // load messages and set up read receipts
        function loadMessages() {
            if (!currentChatId) return;
            if (messagesRef) { try { off(messagesRef); } catch(e){} messagesRef = null; }
            messagesRef = dbRef(database, `messages/${currentChatId}`);
            onValue(messagesRef, async (snap) => {
                const container = document.getElementById('messagesContainer');
                if (!container) return;
                container.innerHTML = '';
                if (!snap.exists()) { container.innerHTML = '<div class="small" style="text-align:center;color:var(--text-secondary)">ëŒ€í™” ì‹œì‘</div>'; return; }

                const messages = [];
                snap.forEach(ch => messages.push({ id: ch.key, ...ch.val() }));
                messages.sort((a,b)=> (a.timestamp||0) - (b.timestamp||0));

                for (const msg of messages) {
                    const isSent = msg.senderId === currentUser.uid;
                    const wrapper = document.createElement('div'); wrapper.className = 'message ' + (isSent ? 'sent' : '');
                    const avatar = document.createElement('div'); avatar.className = 'message-avatar'; avatar.textContent = (isSent ? (currentUser.username ? currentUser.username.charAt(0).toUpperCase() : 'U') : (currentChatUser.data.username ? currentChatUser.data.username.charAt(0).toUpperCase() : '?'));
                    const contentWrap = document.createElement('div'); contentWrap.style.display='flex';contentWrap.style.flexDirection='column';

                    const bubble = document.createElement('div'); bubble.className='message-bubble';
                    if (msg.type === 'image') {
                        const img = document.createElement('img'); img.className='message-image';
                        img.src = msg.imageUrl; img.alt = msg.filename || 'image';
                        img.style.maxWidth = '320px'; img.style.borderRadius='8px';
                        bubble.appendChild(img);
                    } else {
                        bubble.innerHTML = escapeHtml(msg.text || '');
                    }

                    const meta = document.createElement('div'); meta.className='message-meta';
                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit'}) : '';
                    meta.textContent = time;

                    contentWrap.appendChild(bubble);
                    contentWrap.appendChild(meta);

                    // read indicator for sent messages
                    const readEl = document.createElement('div'); readEl.className='read-indicator';
                    if (isSent) {
                        const readByOther = msg.readBy && msg.readBy[currentChatUser.id];
                        readEl.textContent = readByOther ? 'ì½ìŒ' : '';
                        contentWrap.appendChild(readEl);
                    } else {
                        // for received messages, nothing to show for sender; but we'll mark read below
                    }

                    wrapper.appendChild(avatar);
                    wrapper.appendChild(contentWrap);
                    container.appendChild(wrapper);
                }

                // scroll to bottom
                container.scrollTop = container.scrollHeight;

                // mark messages as read for this user (for messages sent by friend)
                markMessagesRead(messages);
            });
        }

        // mark messages as read by currentUser (for messages where senderId !== currentUser.uid)
        async function markMessagesRead(messages) {
            if (!currentChatId || !currentChatUser) return;
            const updates = [];
            for (const msg of messages) {
                if (msg.senderId !== currentUser.uid) {
                    if (!(msg.readBy && msg.readBy[currentUser.uid])) {
                        // set read flag
                        try {
                            await set(dbRef(database, `messages/${currentChatId}/${msg.id}/readBy/${currentUser.uid}`), true);
                        } catch(e){ console.warn('mark read failed', e) }
                    }
                }
            }
            // also clear chat unread flag for current user
            try {
                await update(dbRef(database, `chats/${currentUser.uid}/${currentChatUser.id}`), { unread: false });
            } catch(e){/*ignore*/}
        }

        // load chat list
        function loadChats() {
            if (!currentUser) return;
            if (chatsRef) { try { off(chatsRef); } catch(e){} chatsRef = null; }
            chatsRef = dbRef(database, `chats/${currentUser.uid}`);
            onValue(chatsRef, async (snap) => {
                const container = document.getElementById('chatList'); container.innerHTML = '';
                if (!snap.exists()) {
                    container.innerHTML = `<div class="empty-state" style="text-align:center;padding:20px;color:var(--text-secondary)"><div style="font-size:36px;margin-bottom:8px">ğŸ’¬</div><div>ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>`;
                    return;
                }
                const entries = snap.val();
                const chats = [];
                for (const [fid, chatData] of Object.entries(entries)) {
                    const uSnap = await get(dbRef(database, `users/${fid}`));
                    if (!uSnap.exists()) continue;
                    chats.push({ friendId: fid, friendData: uSnap.val(), chatData });
                }
                chats.sort((a,b)=> (b.chatData.lastMessageTime||0) - (a.chatData.lastMessageTime||0));
                let unreadCount = 0;
                for (const c of chats) {
                    if (c.chatData.unread) unreadCount++;
                    const item = document.createElement('div'); item.className='chat-item';
                    item.innerHTML = `<div class="chat-avatar">${c.friendData.username ? c.friendData.username.charAt(0).toUpperCase() : '?'}</div>
                        <div style="flex:1;min-width:0">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <div style="font-weight:700">${c.friendData.name || 'ì´ë¦„ ì—†ìŒ'}</div>
                                <div class="small">${c.chatData.lastMessageTime ? new Date(c.chatData.lastMessageTime).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}) : ''}</div>
                            </div>
                            <div class="small" style="color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.chatData.lastMessage || ''}</div>
                        </div>
                        ${c.chatData.unread ? '<div style="background:var(--primary);color:#fff;padding:4px 8px;border-radius:12px;font-weight:700">N</div>' : ''}`;
                    item.addEventListener('click', async () => {
                        openChat(c.friendId, c.friendData);
                        // mark chat-level unread false
                        if (c.chatData.unread) await update(dbRef(database, `chats/${currentUser.uid}/${c.friendId}`), { unread: false }).catch(()=>{});
                    });
                    container.appendChild(item);
                }
                // badge
                const badge = document.getElementById('unreadBadge');
                if (unreadCount > 0) { badge.textContent = unreadCount; badge.style.display = 'inline-block'; }
                else badge.style.display = 'none';
            });
        }

        // initial loadChats wrapper
        function loadChatsInitial() { loadChats(); }

        // -------------------- helpers --------------------
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
        }

        // cleanup listeners on unload / logout
        function cleanupAllListeners() {
            try { if (friendsRef) off(friendsRef); } catch(e){}
            try { if (chatsRef) off(chatsRef); } catch(e){}
            try { if (messagesRef) off(messagesRef); } catch(e){}
            try { if (requestsRef) off(requestsRef); } catch(e){}
            friendsRef = chatsRef = messagesRef = requestsRef = null;
        }

        window.addEventListener('beforeunload', () => {
            if (currentUser) update(dbRef(database, `users/${currentUser.uid}`), { online: false, lastSeen: Date.now() }).catch(()=>{});
            cleanupAllListeners();
        });

        // -------------------- UI: tabs and nav --------------------
        document.querySelectorAll('.nav-item').forEach(btn=>{
            btn.addEventListener('click', ()=>{
                document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
                btn.classList.add('active');
                const view = btn.dataset.view;
                if (view === 'friends') {
                    document.getElementById('friendsPanel').style.display = 'flex';
                    document.getElementById('messagesPanel').style.display = 'flex';
                } else {
                    document.getElementById('friendsPanel').style.display = 'none';
                    document.getElementById('messagesPanel').style.display = 'flex';
                }
            });
        });

        document.querySelectorAll('#friendsTabs .tab-btn').forEach(btn=>{
            btn.addEventListener('click', ()=>{
                document.querySelectorAll('#friendsTabs .tab-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                const tab = btn.dataset.tab;
                document.getElementById('friendsList').style.display = tab==='friends-list' ? 'block' : 'none';
                document.getElementById('friendRequests').style.display = tab==='requests' ? 'block' : 'none';
                document.getElementById('addFriend').style.display = tab==='add-friend' ? 'block' : 'none';
            });
        });

        // expose some loads
        function loadFriendRequestsInit(){ loadFriendRequests(); }
        function loadFriendsInit(){ loadFriends(); }
        // initial call when logged in
        // loadFriends()/loadChats()/loadFriendRequests() are called on login and on page init

    </script>
</body>
</html>
