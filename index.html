<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ ë©”ì‹ ì €</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Fredoka:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #7C3AED;
            --primary-dark: #6D28D9;
            --primary-light: #A78BFA;
            --secondary: #EC4899;
            --bg-main: #0F0F1E;
            --bg-card: #1A1A2E;
            --bg-hover: #252541;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --border: #2D2D44;
            --success: #10B981;
            --error: #EF4444;
            --warning: #F59E0B;
        }

        * { margin:0;padding:0;box-sizing:border-box; }
        body { font-family:'Noto Sans KR',sans-serif;background:var(--bg-main);color:var(--text-primary);height:100vh;overflow:hidden }

        .btn{padding:12px 24px;border:none;border-radius:12px;font-weight:600;cursor:pointer}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
        .btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border)}
        .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .error-message{display:none;background:rgba(239,68,68,0.1);border:1px solid var(--error);color:var(--error);padding:12px;border-radius:8px;margin-bottom:16px}
        .error-message.show{display:block}
        .success-message{display:none;background:rgba(16,185,129,0.08);border:1px solid var(--success);color:var(--success);padding:12px;border-radius:8px;margin-bottom:16px}
        .success-message.show{display:block}

        /* layout */
        .main-app{display:flex;height:100vh}
        .sidebar-nav{width:80px;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:20px 0}
        .nav-logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:12px}
        .nav-items{flex:1;display:flex;flex-direction:column;gap:16px}
        .nav-item{width:56px;height:56px;border-radius:12px;background:transparent;border:none;color:var(--text-secondary);cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center}
        .nav-item.active{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
        .nav-user{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--primary-light),var(--secondary));display:flex;align-items:center;justify-content:center;font-weight:700;margin-top:12px}
        .logout-btn{margin-top:8px;width:48px;height:48px;border-radius:12px;background:transparent;border:none;color:var(--text-secondary);cursor:pointer}

        .friends-panel{width:360px;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column}
        .panel-header{padding:18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px}
        .panel-header h2{font-size:20px}
        .panel-header .small-actions{display:flex;gap:8px;align-items:center}
        .search-box{position:relative;flex:1;margin-left:12px}
        .search-box input{width:100%;padding:10px 12px 10px 36px;border-radius:10px;border:1px solid var(--border);background:var(--bg-main);color:var(--text-primary)}
        .search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-secondary)}

        .panel-tabs{display:flex;gap:8px;padding:10px}
        .tab-btn{padding:8px 10px;border-radius:8px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;font-weight:600}
        .tab-btn.active{background:var(--primary);color:#fff}

        .panel-content{flex:1;padding:12px;overflow:auto}
        .friend-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;cursor:pointer}
        .friend-avatar{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary),var(--secondary));font-weight:700}
        .friend-avatar.online::after{content:'';position:absolute;width:12px;height:12px;border-radius:50%;background:var(--success);border:2px solid var(--bg-card);margin-left:28px;margin-top:28px}

        .messages-panel{width:320px;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column}
        .chat-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;cursor:pointer}
        .chat-avatar{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary),var(--secondary));font-weight:700}

        .chat-area{flex:1;display:flex;flex-direction:column;background:var(--bg-main)}
        .chat-header{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border);background:var(--bg-card)}
        .chat-header-left{display:flex;align-items:center;gap:12px}
        .messages-container{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px}
        .message{display:flex;gap:12px;max-width:75%;animation:fade .2s}
        @keyframes fade{from{opacity:.4;transform:translateY(6px)}to{opacity:1;transform:none}}
        .message.sent{margin-left:auto;flex-direction:row-reverse}
        .message-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary-light),var(--secondary));font-weight:600}
        .message-bubble{padding:10px 12px;border-radius:12px;background:var(--bg-card);color:var(--text-primary);word-break:break-word;max-width:100%}
        .message.sent .message-bubble{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border-radius:12px 12px 4px 12px}

        .message-meta{font-size:11px;color:var(--text-secondary);margin-top:6px}
        .read-indicator{font-size:11px;color:var(--text-secondary);margin-top:6px;text-align:right}

        .input-area{padding:12px;border-top:1px solid var(--border);background:var(--bg-card)}
        .input-wrapper{display:flex;gap:8px;align-items:flex-end}
        .message-input{flex:1;border-radius:999px;padding:10px 14px;border:1px solid var(--border);background:var(--bg-main);color:var(--text-primary);resize:none;max-height:120px}
        .send-btn{width:44px;height:44px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;cursor:pointer}

        /* emoji panel: 5 rows x N columns layout */
        .emoji-panel{position:absolute;bottom:96px;right:140px;background:var(--bg-card);border:1px solid var(--border);padding:6px;border-radius:10px;display:grid;grid-auto-flow:column;grid-template-rows:repeat(5,40px);gap:6px;z-index:999;max-height:calc(40px*5 + 6px*4);overflow:auto;display:none}
        .emoji-item{width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;border-radius:6px}

        /* group modal */
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:999}
        .modal-backdrop.active{display:flex}
        .modal{width:520px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px}
        .modal h3{margin-bottom:8px}

        .small{font-size:12px;color:var(--text-secondary)}
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ / íšŒì›ê°€ì… (ê°„ë‹¨) -->
    <div class="auth-container active" id="loginContainer">
        <div class="auth-box" style="padding:28px;max-width:420px">
            <div class="auth-logo">
                <h1>ğŸ’¬ ChatApp</h1>
                <p class="small">ì¹œêµ¬ë“¤ê³¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì†Œí†µí•˜ì„¸ìš”</p>
            </div>

            <div class="error-message" id="loginError"></div>

            <form id="loginForm">
                <div class="form-group" style="margin-bottom:12px">
                    <label for="loginUsername" style="color:var(--text-secondary);font-size:13px">ì•„ì´ë”” ë˜ëŠ” ì´ë©”ì¼</label>
                    <input id="loginUsername" type="text" required placeholder="ì•„ì´ë”” ë˜ëŠ” ì´ë©”ì¼" />
                </div>
                <div class="form-group" style="margin-bottom:12px">
                    <label for="loginPassword" style="color:var(--text-secondary);font-size:13px">ë¹„ë°€ë²ˆí˜¸</label>
                    <input id="loginPassword" type="password" required placeholder="ë¹„ë°€ë²ˆí˜¸" />
                </div>
                <div class="form-actions">
                    <button id="loginBtn" class="btn btn-primary" type="submit">ë¡œê·¸ì¸</button>
                </div>
            </form>

            <div style="margin-top:10px;text-align:center" class="small">
                ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a id="showSignup" style="color:var(--primary);cursor:pointer">íšŒì›ê°€ì…</a>
            </div>
        </div>
    </div>

    <div class="auth-container" id="signupContainer" style="display:none">
        <div class="auth-box" style="padding:28px;max-width:420px">
            <div class="auth-logo">
                <h1>ğŸ’¬ ChatApp</h1>
                <p class="small">ìƒˆ ê³„ì •ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
            </div>

            <div class="error-message" id="signupError"></div>
            <div class="success-message" id="signupSuccess"></div>

            <form id="signupForm">
                <div class="form-group">
                    <label for="signupUsername">ì•„ì´ë””</label>
                    <input id="signupUsername" type="text" required placeholder="ì˜ë¬¸ìˆ«ì 4-20ì" />
                </div>
                <div class="form-group">
                    <label for="signupEmail">ì´ë©”ì¼</label>
                    <input id="signupEmail" type="email" required placeholder="email@example.com" />
                </div>
                <div class="form-group">
                    <label for="signupName">ì´ë¦„</label>
                    <input id="signupName" type="text" required placeholder="í™ê¸¸ë™" />
                </div>
                <div class="form-group">
                    <label for="signupPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <input id="signupPassword" type="password" required placeholder="6ì ì´ìƒ" />
                </div>
                <div class="form-group">
                    <label for="signupPasswordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input id="signupPasswordConfirm" type="password" required placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" />
                </div>
                <div class="form-actions">
                    <button id="signupBtn" class="btn btn-primary" type="submit">íšŒì›ê°€ì…</button>
                    <button id="backToLogin" type="button" class="btn btn-secondary">ëŒì•„ê°€ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± -->
    <div class="main-app" id="mainApp" style="display:none">
        <nav class="sidebar-nav">
            <div class="nav-logo">ğŸ’¬</div>
            <div class="nav-items">
                <button class="nav-item active" data-view="friends" title="ì¹œêµ¬">ğŸ‘¥</button>
                <button class="nav-item" data-view="messages" title="ë©”ì‹œì§€">ğŸ’¬ <span id="unreadBadge" style="display:none;position:absolute;right:6px;top:6px;background:var(--error);color:#fff;border-radius:50%;padding:2px 6px;font-size:11px"></span></button>
            </div>

            <div class="nav-user" id="userProfile" title="ì„¤ì • ì—´ê¸°">U</div>
            <button class="logout-btn" id="logoutBtn" title="ë¡œê·¸ì•„ì›ƒ">ğŸšª</button>
        </nav>

        <aside class="friends-panel" id="friendsPanel">
            <div class="panel-header">
                <div style="display:flex;align-items:center;gap:8px">
                    <h2>ì¹œêµ¬</h2>
                    <div class="small" style="color:var(--text-secondary)"> â€¢ ì‚¬ëŒ / ê·¸ë£¹ ê´€ë¦¬</div>
                </div>
                <div class="panel-header small-actions">
                    <div class="search-box" style="width:220px">
                        <span class="search-icon">ğŸ”</span>
                        <input id="friendSearch" placeholder="ì¹œêµ¬ ê²€ìƒ‰..." />
                    </div>
                    <button id="openCreateGroup" class="btn btn-secondary" style="padding:8px 12px">ê·¸ë£¹ ë§Œë“¤ê¸°</button>
                </div>
            </div>

            <div class="panel-tabs" id="friendsTabs">
                <button class="tab-btn active" data-tab="friends-list">ì¹œêµ¬ ëª©ë¡</button>
                <button class="tab-btn" data-tab="requests">ìš”ì²­ <span id="requestCount" class="small"></span></button>
                <button class="tab-btn" data-tab="add-friend">ì¹œêµ¬ ì¶”ê°€</button>
            </div>

            <div class="panel-content">
                <div id="friendsList">
                    <div class="empty-state">
                        <div style="font-size:36px;margin-bottom:8px">ğŸ‘¥</div>
                        <div>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="small">ì¹œêµ¬ ìš”ì²­ì„ ë³´ë‚´ë³´ì„¸ìš”</div>
                    </div>
                </div>

                <div id="friendRequests" style="display:none">
                    <div id="requestsList">
                        <div class="empty-state">
                            <div style="font-size:36px;margin-bottom:8px">ğŸ“¨</div>
                            <div>ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    </div>
                </div>

                <div id="addFriend" style="display:none">
                    <div style="padding:12px">
                        <div class="error-message" id="addFriendError"></div>
                        <div class="success-message" id="addFriendSuccess"></div>
                        <div class="form-group">
                            <label>ì¹œêµ¬ ì•„ì´ë””</label>
                            <input id="friendUsername" placeholder="friend123" />
                        </div>
                        <div style="display:flex;gap:8px">
                            <button id="addFriendBtn" class="btn btn-primary">ìš”ì²­ ë³´ë‚´ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <aside class="messages-panel" id="messagesPanel" style="display:flex">
            <div class="panel-header">
                <h2>ë©”ì‹œì§€</h2>
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input placeholder="ëŒ€í™” ê²€ìƒ‰..." />
                </div>
            </div>

            <div class="panel-content" id="chatList">
                <div class="empty-state">
                    <div style="font-size:36px;margin-bottom:8px">ğŸ’¬</div>
                    <div>ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>
        </aside>

        <main class="chat-area" id="chatArea">
            <div class="empty-state">
                <div style="font-size:36px;margin-bottom:8px">ğŸ’¬</div>
                <div>ëŒ€í™”ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
            </div>
        </main>
    </div>

    <!-- Emoji panel -->
    <div id="emojiPanel" class="emoji-panel" aria-hidden="true"></div>

    <!-- Group creation modal -->
    <div class="modal-backdrop" id="createGroupModal">
        <div class="modal">
            <h3>ê·¸ë£¹ ë§Œë“¤ê¸°</h3>
            <div class="form-group">
                <label>ê·¸ë£¹ ì´ë¦„</label>
                <input id="groupNameInput" placeholder="ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
            </div>
            <div class="form-group" style="max-height:240px;overflow:auto;border:1px solid var(--border);padding:8px;border-radius:8px">
                <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px">ë©¤ë²„ ì„ íƒ</div>
                <div id="groupMembersList" style="display:flex;flex-direction:column;gap:6px"></div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
                <button class="btn btn-secondary" id="cancelCreateGroup">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="createGroupBtn">ê·¸ë£¹ ìƒì„±</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (database only) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getDatabase, ref, set, push, onValue, get, update, off
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase ì„¤ì • (ê¸°ì¡´ ê°’ ìœ ì§€)
        const firebaseConfig = {
            apiKey: "AIzaSyDyAtNIrWfsROkqi8op6zynWZfjBwEMeh8",
            authDomain: "mess-db5a2.firebaseapp.com",
            databaseURL: "https://mess-db5a2-default-rtdb.firebaseio.com",
            projectId: "mess-db5a2",
            storageBucket: "mess-db5a2.appspot.com",
            messagingSenderId: "125385749508",
            appId: "1:125385749508:web:f3e80ebb8cfd9e397af151",
            measurementId: "G-W6LN7XGMZB"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let currentUser = null;
        let currentChatId = null;
        let currentChatMeta = null; // { type: 'user'|'group', id, data }

        // listeners
        let friendsRef = null;
        let chatsRef = null;
        let messagesRef = null;
        let requestsRef = null;

        function sanitizeKey(str) { if (!str || typeof str !== 'string') return str; return str.replace(/[.#$\[\]]/g, (c) => '%' + c.charCodeAt(0).toString(16)); }

        // UI elements
        const loginContainer = document.getElementById('loginContainer');
        const signupContainer = document.getElementById('signupContainer');
        const mainApp = document.getElementById('mainApp');

        function showLogin(){ loginContainer.style.display=''; signupContainer.style.display='none'; mainApp.style.display='none' }
        function showSignup(){ loginContainer.style.display='none'; signupContainer.style.display=''; mainApp.style.display='none' }
        function showMainApp(){ loginContainer.style.display='none'; signupContainer.style.display='none'; mainApp.style.display='' }

        // Signup
        document.getElementById('signupForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const username = document.getElementById('signupUsername').value.trim().toLowerCase();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const name = document.getElementById('signupName').value.trim();
            const pwd = document.getElementById('signupPassword').value;
            const pwdConfirm = document.getElementById('signupPasswordConfirm').value;
            const err = document.getElementById('signupError');
            const ok = document.getElementById('signupSuccess');
            err.classList.remove('show'); ok.classList.remove('show');
            const btn = document.getElementById('signupBtn');

            if (!/^[a-zA-Z0-9]{4,20}$/.test(username)) { err.textContent='ì•„ì´ë””ëŠ” ì˜ë¬¸/ìˆ«ì 4-20ìì…ë‹ˆë‹¤.'; err.classList.add('show'); return; }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { err.textContent='ìœ íš¨í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'; err.classList.add('show'); return; }
            if (pwd.length < 6) { err.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì…ë‹ˆë‹¤.'; err.classList.add('show'); return; }
            if (pwd !== pwdConfirm) { err.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; err.classList.add('show'); return; }

            btn.disabled=true; btn.innerHTML='<span class="spinner"></span> ê°€ì… ì¤‘...';
            try {
                const usernameSnap = await get(ref(database, `usernames/${username}`));
                if (usernameSnap.exists()) { err.textContent='ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'; err.classList.add('show'); return; }
                const emailKey = sanitizeKey(email);
                const emailSnap = await get(ref(database, `emails/${emailKey}`));
                if (emailSnap.exists()) { err.textContent='ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.'; err.classList.add('show'); return; }

                const userId = push(ref(database,'users')).key;
                await set(ref(database, `users/${userId}`), {
                    username, email, name, password: btoa(pwd), status: 'ì•ˆë…•í•˜ì„¸ìš”!', createdAt: Date.now(), online:false
                });
                await set(ref(database, `usernames/${username}`), userId);
                await set(ref(database, `emails/${emailKey}`), userId);
                ok.textContent='íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•˜ì„¸ìš”.'; ok.classList.add('show');
                document.getElementById('signupForm').reset();
                setTimeout(showLogin,1200);
            } catch (e){ console.error(e); err.textContent='íšŒì›ê°€ì… ì˜¤ë¥˜: '+(e.message||e); err.classList.add('show'); }
            finally { btn.disabled=false; btn.textContent='íšŒì›ê°€ì…' }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const identifier = document.getElementById('loginUsername').value.trim().toLowerCase();
            const pwd = document.getElementById('loginPassword').value;
            const err = document.getElementById('loginError');
            err.classList.remove('show');
            const btn = document.getElementById('loginBtn'); btn.disabled=true; btn.innerHTML='<span class="spinner"></span> ë¡œê·¸ì¸ ì¤‘...';
            try {
                let userId = null;
                const usernameSnap = await get(ref(database, `usernames/${identifier}`));
                if (usernameSnap.exists()) userId = usernameSnap.val();
                else {
                    const emailKey = sanitizeKey(identifier);
                    const emailSnap = await get(ref(database, `emails/${emailKey}`));
                    if (emailSnap.exists()) userId = emailSnap.val();
                }
                if (!userId) { err.textContent='ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤.'; err.classList.add('show'); return; }
                const userSnap = await get(ref(database, `users/${userId}`));
                if (!userSnap.exists()) { err.textContent='ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; err.classList.add('show'); return; }
                const data = userSnap.val();
                if (data.password !== btoa(pwd)) { err.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; err.classList.add('show'); return; }

                currentUser = { uid:userId, username:data.username, name:data.name, email:data.email||'', status:data.status||'' };
                localStorage.setItem('chatAppUser', JSON.stringify(currentUser));
                await update(ref(database, `users/${currentUser.uid}`), { online:true, lastSeen:Date.now() });
                showMainApp();
                loadUserData(); loadFriends(); loadChats(); loadFriendRequests();
            } catch (e) { console.error(e); err.textContent='ë¡œê·¸ì¸ ì˜¤ë¥˜: '+(e.message||e); err.classList.add('show'); }
            finally { btn.disabled=false; btn.textContent='ë¡œê·¸ì¸' }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async ()=>{
            if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try { if (currentUser) await update(ref(database, `users/${currentUser.uid}`), { online:false, lastSeen:Date.now() }); } catch(e){}
            cleanupAllListeners(); localStorage.removeItem('chatAppUser'); currentUser=null; showLogin();
        });

        // Init from storage
        (function initFromStorage(){
            const saved = localStorage.getItem('chatAppUser');
            if (saved) { currentUser = JSON.parse(saved); showMainApp(); loadUserData(); loadFriends(); loadChats(); loadFriendRequests(); update(ref(database, `users/${currentUser.uid}`), { online:true, lastSeen:Date.now() }).catch(()=>{}); }
            else showLogin();
        })();

        // load user UI
        function loadUserData(){ if (!currentUser) return; const el=document.getElementById('userProfile'); el.textContent = currentUser.username ? currentUser.username.charAt(0).toUpperCase() : (currentUser.name?currentUser.name.charAt(0).toUpperCase():'U') }

        // friends & requests
        async function loadFriends(){
            if (!currentUser) return;
            if (friendsRef) { try { off(friendsRef); } catch(e){} }
            friendsRef = ref(database, `friends/${currentUser.uid}`);
            onValue(friendsRef, async (snap)=>{
                const container = document.getElementById('friendsList'); container.innerHTML='';
                if (!snap.exists()){ container.innerHTML = `<div class="empty-state"><div style="font-size:36px;margin-bottom:8px">ğŸ‘¥</div><div>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>`; return; }
                const ids = Object.keys(snap.val());
                for (const fid of ids){
                    const uSnap = await get(ref(database, `users/${fid}`));
                    if (!uSnap.exists()) continue;
                    const u = uSnap.val();
                    const item = document.createElement('div'); item.className='friend-item';
                    item.innerHTML = `<div class="friend-avatar ${u.online?'online':''}">${u.username?u.username.charAt(0).toUpperCase():'?'}</div>
                        <div style="flex:1;min-width:0"><div style="font-weight:700">${u.name||'ì´ë¦„ ì—†ìŒ'}</div><div class="small">@${u.username||''} â€¢ ${u.status||''}</div></div>`;
                    item.addEventListener('click', ()=> openChat({ type:'user', id: fid, data: u }));
                    container.appendChild(item);
                }
            });
        }

        function loadFriendRequests(){
            if (!currentUser) return;
            if (requestsRef) { try { off(requestsRef); } catch(e){} }
            requestsRef = ref(database, `friendRequests/${currentUser.uid}`);
            onValue(requestsRef, async (snap)=>{
                const list = document.getElementById('requestsList'); list.innerHTML=''; const countEl = document.getElementById('requestCount');
                if (!snap.exists()){ list.innerHTML=`<div class="empty-state"><div style="font-size:36px;margin-bottom:8px">ğŸ“¨</div><div>ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>`; countEl.textContent=''; return; }
                const entries = Object.entries(snap.val());
                countEl.textContent = `(${entries.length})`;
                for (const [senderId,data] of entries){
                    const uSnap = await get(ref(database, `users/${senderId}`));
                    const u = uSnap.exists()?uSnap.val():{username:data.username||'unknown',name:data.name||'ì´ë¦„ ì—†ìŒ'};
                    const item = document.createElement('div'); item.className='friend-item';
                    item.innerHTML = `<div class="friend-avatar">${u.username?u.username.charAt(0).toUpperCase():'?'}</div>
                        <div style="flex:1;min-width:0"><div style="font-weight:700">${u.name||'ì´ë¦„ ì—†ìŒ'}</div><div class="small">@${u.username||''} â€¢ ìš”ì²­: ${new Date(data.timestamp||Date.now()).toLocaleString()}</div></div>
                        <div style="display:flex;gap:6px"><button class="btn btn-secondary btn-reject" data-id="${senderId}">ê±°ì ˆ</button><button class="btn btn-primary btn-accept" data-id="${senderId}">ìˆ˜ë½</button></div>`;
                    item.querySelector('.btn-accept').addEventListener('click', ()=> acceptFriendRequest(senderId));
                    item.querySelector('.btn-reject').addEventListener('click', ()=> rejectFriendRequest(senderId));
                    list.appendChild(item);
                }
            });
        }

        async function acceptFriendRequest(senderId){
            if (!currentUser) return;
            try {
                await set(ref(database, `friends/${currentUser.uid}/${senderId}`), { addedAt: Date.now() });
                await set(ref(database, `friends/${senderId}/${currentUser.uid}`), { addedAt: Date.now() });
                await set(ref(database, `friendRequests/${currentUser.uid}/${senderId}`), null);
                alert('ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.');
            } catch(e){ console.error(e); alert('ìˆ˜ë½ ì˜¤ë¥˜') }
        }
        async function rejectFriendRequest(senderId){
            if (!currentUser) return;
            try { await set(ref(database, `friendRequests/${currentUser.uid}/${senderId}`), null); alert('ê±°ì ˆ ì™„ë£Œ'); } catch(e){ console.error(e); alert('ê±°ì ˆ ì˜¤ë¥˜') }
        }

        // Send friend request
        document.getElementById('addFriendBtn').addEventListener('click', async ()=>{
            const username = document.getElementById('friendUsername').value.trim().toLowerCase();
            const err = document.getElementById('addFriendError'); const ok = document.getElementById('addFriendSuccess'); err.classList.remove('show'); ok.classList.remove('show');
            if (!username){ err.textContent='ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”'; err.classList.add('show'); return; }
            if (!currentUser){ err.textContent='ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”'; err.classList.add('show'); return; }
            if (username === currentUser.username){ err.textContent='ìê¸° ìì‹ ì€ ë¶ˆê°€'; err.classList.add('show'); return; }
            const btn = document.getElementById('addFriendBtn'); btn.disabled=true; btn.innerHTML='<span class="spinner"></span> ìš”ì²­ ì¤‘...';
            try {
                const uSnap = await get(ref(database, `usernames/${username}`));
                if (!uSnap.exists()){ err.textContent='ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'; err.classList.add('show'); return; }
                const recipientId = uSnap.val();
                const fSnap = await get(ref(database, `friends/${currentUser.uid}/${recipientId}`));
                if (fSnap.exists()){ err.textContent='ì´ë¯¸ ì¹œêµ¬ì…ë‹ˆë‹¤'; err.classList.add('show'); return; }
                const rSnap = await get(ref(database, `friendRequests/${recipientId}/${currentUser.uid}`));
                if (rSnap.exists()){ err.textContent='ì´ë¯¸ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤'; err.classList.add('show'); return; }
                await set(ref(database, `friendRequests/${recipientId}/${currentUser.uid}`), { from: currentUser.uid, username: currentUser.username, name: currentUser.name||'', timestamp:Date.now(), status:'pending' });
                ok.textContent='ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤'; ok.classList.add('show'); document.getElementById('friendUsername').value='';
            } catch(e){ console.error(e); err.textContent='ìš”ì²­ ì¤‘ ì˜¤ë¥˜: '+(e.message||e); err.classList.add('show'); }
            finally{ btn.disabled=false; btn.textContent='ìš”ì²­ ë³´ë‚´ê¸°' }
        });

        // Chat open / group support
        async function openChat(meta){
            // meta: { type:'user'|'group', id, data }
            if (!currentUser) return;
            currentChatMeta = meta;
            currentChatId = meta.id;
            if (messagesRef) { try { off(messagesRef); } catch(e){} messagesRef=null; }
            // switch to messages view
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            document.querySelector('[data-view="messages"]').classList.add('active');
            document.getElementById('friendsPanel').style.display='none';
            document.getElementById('messagesPanel').style.display='flex';
            document.getElementById('chatArea').style.display='flex';

            // build header
            let headerHtml = '';
            if (meta.type === 'user') {
                const u = meta.data;
                const initial = u.username ? u.username.charAt(0).toUpperCase() : '?';
                const onlineStatus = u.online ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';
                headerHtml = `<div class="chat-header-left"><div class="friend-avatar" style="width:42px;height:42px;border-radius:50%">${initial}</div><div><div style="font-weight:700">${u.name||'ì´ë¦„ ì—†ìŒ'}</div><div class="small">${onlineStatus} â€¢ ${u.status||''}</div></div></div>
                <div><button id="emojiBtn" class="btn btn-secondary" style="padding:8px 10px">ğŸ˜Š</button></div>`;
            } else {
                // group: fetch group meta if data not provided
                let g = meta.data;
                if (!g) {
                    const gSnap = await get(ref(database, `groupChats/${meta.id}`));
                    g = gSnap.exists()?gSnap.val():{ name:'ê·¸ë£¹', members:{} };
                }
                const membersCount = g.members?Object.keys(g.members).length:0;
                headerHtml = `<div class="chat-header-left"><div class="friend-avatar" style="width:42px;height:42px;border-radius:10px">ğŸ‘¥</div><div><div style="font-weight:700">${g.name||'ê·¸ë£¹ ì±„íŒ…'}</div><div class="small">${membersCount}ëª…</div></div></div>
                <div><button id="emojiBtn" class="btn btn-secondary" style="padding:8px 10px">ğŸ˜Š</button></div>`;
            }

            document.getElementById('chatArea').innerHTML = `
                <div class="chat-header">${headerHtml}</div>
                <div class="messages-container" id="messagesContainer"></div>
                <div class="input-area"><div class="input-wrapper">
                    <textarea id="messageInput" class="message-input" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <button id="sendBtn" class="send-btn">â¤</button>
                </div></div>
            `;

            setupMessageInput(); loadMessages();

            // mark unread false for this user
            try { await update(ref(database, `chats/${currentUser.uid}/${currentChatId}`), { unread:false }); } catch(e){}
        }

        function setupMessageInput(){
            const textarea = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const emojiBtn = document.getElementById('emojiBtn');
            if (!textarea || !sendBtn) return;
            textarea.addEventListener('input', function(){ this.style.height='auto'; this.style.height = Math.min(this.scrollHeight,120)+'px'; });
            textarea.addEventListener('keypress', function(e){ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
            sendBtn.addEventListener('click', sendMessage);

            // emoji panel: populate once
            if (document.getElementById('emojiPanel').children.length===0){
                const EMOJIS = ['ğŸ˜€','ğŸ˜','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜','ğŸ˜˜','ğŸ¤—','ğŸ¤”','ğŸ˜','ğŸ˜­','ğŸ˜…','ğŸ˜‡','ğŸ¤©','ğŸ˜´','ğŸ‘','ğŸ‘','ğŸ‘','ğŸ™','ğŸ‰','â¤ï¸','ğŸ”¥','ğŸ’¯','ğŸ¤','ğŸ¤','ğŸ™Œ','ğŸ˜¬','ğŸ˜¡','ğŸ¤–','ğŸŒ¸','ğŸ•','â˜•','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜‹','ğŸ˜œ','ğŸ¤¤','ğŸ˜±','ğŸ˜³','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ˜“','ğŸ˜”','ğŸ˜•','ğŸ˜–','ğŸ˜','ğŸ˜¤','ğŸ˜ ','ğŸ˜ª','ğŸ¤’','ğŸ¤•','ğŸ¤§','ğŸ¥³','ğŸ¤ ','ğŸ¤¡','ğŸ‘»','ğŸ’©'];
                const panel = document.getElementById('emojiPanel');
                for (const e of EMOJIS){
                    const d = document.createElement('div'); d.className='emoji-item'; d.textContent=e;
                    d.addEventListener('click', ()=>{ insertEmoji(e); panel.style.display='none'; textarea.focus(); });
                    panel.appendChild(d);
                }
            }

            if (emojiBtn){
                emojiBtn.addEventListener('click', (ev)=>{
                    const panel = document.getElementById('emojiPanel');
                    if (!panel) return;
                    panel.style.display = (panel.style.display==='block') ? 'none' : 'block';
                });
            }

            document.addEventListener('click', (ev)=>{
                const panel = document.getElementById('emojiPanel');
                if (!panel) return;
                if (ev.target.closest('#emojiPanel') || ev.target.id==='emojiBtn') return;
                panel.style.display = 'none';
            });
        }

        function insertEmoji(emoji){
            const ta = document.getElementById('messageInput');
            if (!ta) return;
            const start = ta.selectionStart || ta.value.length;
            const end = ta.selectionEnd || start;
            ta.value = ta.value.slice(0,start) + emoji + ta.value.slice(end);
            ta.focus();
            ta.selectionStart = ta.selectionEnd = start + emoji.length;
            ta.dispatchEvent(new Event('input'));
        }

        // sendMessage handles both user and group chats
        async function sendMessage(){
            const ta = document.getElementById('messageInput');
            if (!ta || !currentChatId || !currentChatMeta) return;
            const text = ta.value.trim();
            if (!text) return;
            try {
                const mRef = ref(database, `messages/${currentChatId}`);
                await push(mRef, { type:'text', text, senderId: currentUser.uid, senderUsername: currentUser.username, timestamp: Date.now() });

                if (currentChatMeta.type === 'user'){
                    await update(ref(database, `chats/${currentUser.uid}/${currentChatId}`), { lastMessage:text, lastMessageTime:Date.now(), unread:false });
                    await update(ref(database, `chats/${currentChatId}/${currentUser.uid}`), { lastMessage:text, lastMessageTime:Date.now(), unread:true });
                } else {
                    // group: update chats entry for each member
                    const gSnap = await get(ref(database, `groupChats/${currentChatId}`));
                    const g = gSnap.exists()?gSnap.val():null;
                    if (g && g.members){
                        const members = Object.keys(g.members);
                        const updates = {};
                        members.forEach(mid=>{
                            updates[`chats/${mid}/${currentChatId}/lastMessage`] = text;
                            updates[`chats/${mid}/${currentChatId}/lastMessageTime`] = Date.now();
                            updates[`chats/${mid}/${currentChatId}/unread`] = (mid === currentUser.uid) ? false : true;
                            updates[`chats/${mid}/${currentChatId}/type`] = 'group';
                            updates[`chats/${mid}/${currentChatId}/name`] = g.name || 'ê·¸ë£¹ ì±„íŒ…';
                        });
                        await update(ref(database, `/`), updates);
                    }
                }

                ta.value=''; ta.style.height='auto';
            } catch(e){ console.error('sendMessage error', e); alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: '+(e.message||e)) }
        }

        // messages loader & read marking
        function loadMessages(){
            if (!currentChatId) return;
            if (messagesRef) { try { off(messagesRef); } catch(e){} messagesRef=null; }
            messagesRef = ref(database, `messages/${currentChatId}`);
            onValue(messagesRef, async (snap)=>{
                const container = document.getElementById('messagesContainer');
                if (!container) return;
                container.innerHTML='';
                if (!snap.exists()){ container.innerHTML='<div class="small" style="text-align:center;color:var(--text-secondary)">ëŒ€í™” ì‹œì‘</div>'; return; }
                const messages = [];
                snap.forEach(ch=>messages.push({ id:ch.key, ...ch.val() }));
                messages.sort((a,b)=> (a.timestamp||0)-(b.timestamp||0));
                for (const msg of messages){
                    const isSent = msg.senderId === currentUser.uid;
                    const wrapper = document.createElement('div'); wrapper.className='message '+(isSent?'sent':'');
                    const avatar = document.createElement('div'); avatar.className='message-avatar'; avatar.textContent = isSent ? (currentUser.username?currentUser.username.charAt(0).toUpperCase():'U') : (currentChatMeta.type==='user' ? (currentChatMeta.data.username?currentChatMeta.data.username.charAt(0).toUpperCase():'?') : 'ğŸ‘¥');
                    const contentWrap = document.createElement('div'); contentWrap.style.display='flex'; contentWrap.style.flexDirection='column';
                    const bubble = document.createElement('div'); bubble.className='message-bubble';
                    bubble.innerHTML = escapeHtml(msg.text || '');
                    const meta = document.createElement('div'); meta.className='message-meta'; meta.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}) : '';
                    contentWrap.appendChild(bubble); contentWrap.appendChild(meta);
                    if (isSent){
                        const readEl = document.createElement('div'); readEl.className='read-indicator'; readEl.textContent = (msg.readBy && msg.readBy[currentChatMeta.type==='user'?currentChatMeta.id:currentUser.uid]) ? 'ì½ìŒ' : '';
                        contentWrap.appendChild(readEl);
                    }
                    wrapper.appendChild(avatar); wrapper.appendChild(contentWrap);
                    container.appendChild(wrapper);
                }
                container.scrollTop = container.scrollHeight;

                // mark unread messages as read
                for (const msg of messages){
                    if (msg.senderId !== currentUser.uid){
                        const already = msg.readBy && msg.readBy[currentUser.uid];
                        if (!already){
                            try{ await set(ref(database, `messages/${currentChatId}/${msg.id}/readBy/${currentUser.uid}`), true); } catch(e){ console.warn('mark read failed', e) }
                        }
                    }
                }
                // clear chat-level unread
                try{ await update(ref(database, `chats/${currentUser.uid}/${currentChatId}`), { unread:false }); } catch(e){}
            });
        }

        // load chat list (handles both user and group chats)
        function loadChatList(){
            if (!currentUser) return;
            if (chatsRef) { try { off(chatsRef); } catch(e){} chatsRef=null; }
            chatsRef = ref(database, `chats/${currentUser.uid}`);
            onValue(chatsRef, async (snap)=>{
                const container = document.getElementById('chatList'); container.innerHTML='';
                if (!snap.exists()){ container.innerHTML=`<div class="empty-state"><div style="font-size:36px;margin-bottom:8px">ğŸ’¬</div><div>ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>`; return; }
                const entries = snap.val();
                const chats = [];
                for (const [chatId, chatData] of Object.entries(entries)){
                    if (chatData.type && chatData.type==='group'){
                        const gSnap = await get(ref(database, `groupChats/${chatId}`));
                        if (!gSnap.exists()) continue;
                        chats.push({ chatId, chatData, isGroup:true, meta:gSnap.val() });
                    } else {
                        // treat key as user id (legacy)
                        const uSnap = await get(ref(database, `users/${chatId}`));
                        if (!uSnap.exists()) continue;
                        chats.push({ chatId, chatData, isGroup:false, meta:uSnap.val() });
                    }
                }
                chats.sort((a,b)=> (b.chatData.lastMessageTime||0) - (a.chatData.lastMessageTime||0));
                let unreadCount=0;
                for (const c of chats){
                    if (c.chatData.unread) unreadCount++;
                    const item = document.createElement('div'); item.className='chat-item';
                    if (c.isGroup){
                        const name = c.chatData.name || c.meta.name || 'ê·¸ë£¹ ì±„íŒ…';
                        item.innerHTML = `<div class="chat-avatar">ğŸ‘¥</div>
                            <div style="flex:1;min-width:0"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">${escapeHtml(name)}</div><div class="small">${c.chatData.lastMessageTime?new Date(c.chatData.lastMessageTime).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):''}</div></div><div class="small" style="color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.chatData.lastMessage||''}</div></div>${c.chatData.unread?'<div style="background:var(--primary);color:#fff;padding:4px 8px;border-radius:12px;font-weight:700">N</div>':''}`;
                        item.addEventListener('click', ()=> openChat({ type:'group', id:c.chatId, data:c.meta }));
                    } else {
                        const u = c.meta;
                        const initial = u.username?u.username.charAt(0).toUpperCase():'?';
                        item.innerHTML = `<div class="chat-avatar">${initial}</div>
                            <div style="flex:1;min-width:0"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">${u.name||'ì´ë¦„ ì—†ìŒ'}</div><div class="small">${c.chatData.lastMessageTime?new Date(c.chatData.lastMessageTime).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):''}</div></div><div class="small" style="color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.chatData.lastMessage||''}</div></div>${c.chatData.unread?'<div style="background:var(--primary);color:#fff;padding:4px 8px;border-radius:12px;font-weight:700">N</div>':''}`;
                        item.addEventListener('click', ()=> openChat({ type:'user', id:c.chatId, data:u }));
                    }
                    container.appendChild(item);
                }
                const badge = document.getElementById('unreadBadge');
                if (unreadCount>0){ badge.textContent=unreadCount; badge.style.display='inline-block' } else badge.style.display='none';
            });
        }

        function loadChats(){ loadChatList(); }

        function escapeHtml(str){ if (str===null||str===undefined) return ''; return String(str).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

        function cleanupAllListeners(){
            try{ if (friendsRef) off(friendsRef); }catch(e){}
            try{ if (chatsRef) off(chatsRef); }catch(e){}
            try{ if (messagesRef) off(messagesRef); }catch(e){}
            try{ if (requestsRef) off(requestsRef); }catch(e){}
            friendsRef=chatsRef=messagesRef=requestsRef=null;
        }

        window.addEventListener('beforeunload', ()=>{
            if (currentUser) update(ref(database, `users/${currentUser.uid}`), { online:false, lastSeen:Date.now() }).catch(()=>{});
            cleanupAllListeners();
        });

        // UI: tabs & nav
        document.querySelectorAll('.nav-item').forEach(btn=> btn.addEventListener('click', ()=>{
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); btn.classList.add('active');
            const view = btn.dataset.view;
            if (view==='friends'){ document.getElementById('friendsPanel').style.display='flex'; document.getElementById('messagesPanel').style.display='flex'; document.getElementById('chatArea').style.display='none' }
            else { document.getElementById('friendsPanel').style.display='none'; document.getElementById('messagesPanel').style.display='flex'; if (currentChatId) document.getElementById('chatArea').style.display='flex' }
        }));

        document.querySelectorAll('#friendsTabs .tab-btn').forEach(btn=> btn.addEventListener('click', ()=>{
            document.querySelectorAll('#friendsTabs .tab-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            const tab = btn.dataset.tab;
            document.getElementById('friendsList').style.display = tab==='friends-list' ? 'block' : 'none';
            document.getElementById('friendRequests').style.display = tab==='requests' ? 'block' : 'none';
            document.getElementById('addFriend').style.display = tab==='add-friend' ? 'block' : 'none';
        }));

        // Group creation modal logic
        const createGroupModal = document.getElementById('createGroupModal');
        const openCreateGroupBtn = document.getElementById('openCreateGroup');
        const cancelCreateGroupBtn = document.getElementById('cancelCreateGroup');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const groupMembersList = document.getElementById('groupMembersList');
        openCreateGroupBtn.addEventListener('click', async ()=>{
            if (!currentUser) return alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”');
            // populate friends as checkboxes
            groupMembersList.innerHTML = '<div class="small">ë¡œë”© ì¤‘...</div>';
            const fSnap = await get(ref(database, `friends/${currentUser.uid}`));
            const friends = fSnap.exists()?Object.keys(fSnap.val()):[];
            groupMembersList.innerHTML = '';
            // include self by default (hidden)
            const selfRow = document.createElement('label'); selfRow.style.display='none';
            selfRow.innerHTML = `<input type="checkbox" checked value="${currentUser.uid}" /> ${escapeHtml(currentUser.name||currentUser.username)}`; groupMembersList.appendChild(selfRow);
            for (const fid of friends){
                const uSnap = await get(ref(database, `users/${fid}`));
                if (!uSnap.exists()) continue;
                const u = uSnap.val();
                const row = document.createElement('label'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px';
                row.innerHTML = `<input type="checkbox" value="${fid}" /> <div style="font-weight:700">${escapeHtml(u.name||'ì´ë¦„ ì—†ìŒ')}</div> <div class="small" style="color:var(--text-secondary)">@${escapeHtml(u.username||'')}</div>`;
                groupMembersList.appendChild(row);
            }
            createGroupModal.classList.add('active');
        });
        cancelCreateGroupBtn.addEventListener('click', ()=> createGroupModal.classList.remove('active'));
        createGroupBtn.addEventListener('click', async ()=>{
            const name = document.getElementById('groupNameInput').value.trim();
            if (!name) return alert('ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
            // collect checked members
            const checked = Array.from(groupMembersList.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
            if (!checked.includes(currentUser.uid)) checked.push(currentUser.uid);
            if (checked.length < 2) return alert('ë©¤ë²„ë¥¼ ìµœì†Œ 2ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”');
            try {
                const chatId = push(ref(database,'groupChats')).key;
                const membersObj = {}; checked.forEach(id=>membersObj[id]=true);
                await set(ref(database, `groupChats/${chatId}`), { name, createdBy: currentUser.uid, members: membersObj, createdAt: Date.now() });
                // create chat entries for each member
                const updates = {};
                checked.forEach(mid=>{
                    updates[`chats/${mid}/${chatId}`] = { type:'group', name, lastMessage:'', lastMessageTime: Date.now(), unread: mid===currentUser.uid?false:true };
                });
                await update(ref(database, `/`), updates);
                createGroupModal.classList.remove('active');
                alert('ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
                loadChats();
            } catch(e){ console.error('ê·¸ë£¹ ìƒì„± ì˜¤ë¥˜', e); alert('ê·¸ë£¹ ìƒì„± ì‹¤íŒ¨: '+(e.message||e)) }
        });

        // show/hide signup/login toggles
        document.getElementById('showSignup').addEventListener('click', showSignup);
        document.getElementById('backToLogin').addEventListener('click', showLogin);

        // initial loads when logged in
        function loadFriendsInit(){ loadFriends(); }
        function loadFriendRequestsInit(){ loadFriendRequests(); }

        // initial chat loads
        // called after login or initFromStorage
        function loadChatsInit(){ loadChats(); }

        // Run after login
        // these functions are called earlier in login flow
    </script>
</body>
</html>
